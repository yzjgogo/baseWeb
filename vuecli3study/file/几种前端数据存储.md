# ä¸¢èŠéº»localStorageæ¡è¥¿ç“œlocalforageã€IndexedDB

[Hijin](https://juejin.cn/user/1486195453602173/posts)

2023-09-141,390é˜…è¯»4åˆ†é’Ÿ

![img](https://p6-piu.byteimg.com/tos-cn-i-8jisjyls3a/fa501ba562f845bcb9d5207fdec8886f~tplv-8jisjyls3a-image.image)

åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œå‰ç«¯å¸¸ç”¨çš„å­˜å‚¨éƒ½æ˜¯cookiesã€Web Storageï¼ˆsessionStorageã€localStorageï¼‰ï¼Œè™½ç„¶ä½¿ç”¨ç®€å•ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸¤ä¸ªæ˜æ˜¾çš„å¼Šç«¯ã€‚

1. `å­˜å‚¨ç©ºé—´é™åˆ¶`:cookies 4Kb,sessionStorageã€localStorage ä¸€èˆ¬æ˜¯5Mï¼Œå¯¹äºå­˜å‚¨æ›´å¤§é‡çš„ç»“æ„åŒ–æ•°æ®æ¥è¯´åŠ›ä¸ä»å¿ƒ
2. `å­˜å–ä¸ä¾¿`ï¼šå­˜å…¥çš„å†…å®¹éœ€è¦ç»è¿‡åºåˆ—åŒ–ï¼Œå–å€¼çš„æ—¶å€™éœ€è¦é€šè¿‡ååºåˆ—åŒ–

*è€Œ IndexedDB æä¾›äº†è¿™ç§åœºæ™¯çš„è§£å†³æ–¹æ¡ˆï¼Œlocalforageåˆ™ä½¿å¾—IndexedDBç”¨èµ·æ¥å¯ä»¥åƒWeb Storageä¸€æ ·ç®€å•*

## IndexedDB

å¦‚æœä½ è§‰å¾—äº†è§£IndexedDBå¤ªéº»çƒ¦ï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹©è·³è¿‡ï¼Œç›´æ¥åˆ°ä¸‹ä¸€èŠ‚localforageğŸ˜¹ğŸ˜¹ğŸ˜¹

### IndexedDB ä¼˜åŠ¿

[IndexedDB](https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FIndexedDB_API) æ˜¯ä¸€ç§åº•å±‚ APIï¼Œç”¨äºåœ¨å®¢æˆ·ç«¯å­˜å‚¨å¤§é‡çš„ç»“æ„åŒ–æ•°æ®ï¼ˆä¹ŸåŒ…æ‹¬æ–‡ä»¶/äºŒè¿›åˆ¶å¤§å‹å¯¹è±¡ï¼ˆblobsï¼‰ï¼‰ã€‚

*å­˜å–æ–¹ä¾¿*

IndexedDB æ˜¯ä¸€ä¸ª**äº‹åŠ¡å‹æ•°æ®åº“ç³»ç»Ÿ**ï¼Œç±»ä¼¼äºåŸºäº **SQL çš„ RDBMS**ã€‚ç„¶è€Œï¼Œä¸åƒ RDBMS ä½¿ç”¨å›ºå®šåˆ—è¡¨ã€‚

IndexedDB æ˜¯ä¸€ä¸ª**åŸºäº JavaScript çš„é¢å‘å¯¹è±¡æ•°æ®åº“**ï¼Œå…è®¸æ‚¨å­˜å‚¨å’Œæ£€ç´¢ç”¨é”®ç´¢å¼•çš„å¯¹è±¡ï¼Œå¯ä»¥å­˜å‚¨[ç»“æ„åŒ–å…‹éš†ç®—æ³•](https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWeb_Workers_API%2FStructured_clone_algorithm)æ”¯æŒçš„ä»»ä½•å¯¹è±¡ï¼Œä¸éœ€è¦ç»è¿‡åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ã€‚å¦‚ä¸‹

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/18cf481350634378b542204bf06413a2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1266&h=566&s=113787&e=png&b=fdfdfd)*å­˜å‚¨ç©ºé—´å¤§*

IndexedDB çš„å‚¨å­˜ç©ºé—´å¹¶æ²¡æœ‰åšé™åˆ¶ã€‚

*å¼‚æ­¥å­˜å–*

localStorageå¦‚æœå­˜å‚¨å†…å®¹å¤šçš„è¯ä¼šæ¶ˆè€—å†…å­˜ç©ºé—´ï¼Œä¼šå¯¼è‡´é¡µé¢å˜å¡ã€‚è€ŒIndexedDBæ‰§è¡Œçš„æ“ä½œæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œä¸ä¼šé˜»å¡åº”ç”¨ç¨‹åºï¼Œå¯åœ¨[Web Worker](https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWeb_Workers_API) ä½¿ç”¨ã€‚

*å…¼å®¹æ€§å¥½*

é…åˆlocalforageçš„ä¼˜é›…é™çº§ç­–ç•¥ï¼ˆåé¢è¡¥å……ï¼‰ï¼Œå…¼å®¹æ€§è¿™ä¸€å—å®Œå…¨ä¸ç”¨æ“å¿ƒï¼Œå¤§èƒ†ç”¨å°±å¯¹äº†ğŸ‘ğŸ‘ğŸ‘ğŸ‘![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1307a1dc1c1d410b8f395e40a258588d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1484&h=766&s=126134&e=png&b=fefefe)

### IndexedDBç®€å•çš„ä½¿ç”¨

#### é“¾æ¥/åˆ›å»ºåº“

```js
let db = null;
const dbName = "testDB",
storeName = "testStore";
const openDB = () => {
  // é“¾æ¥æ•°æ®åº“ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
  const DBOpenRequest = window.indexedDB.open(dbName);
  DBOpenRequest.onsuccess = function (event) {
    db = event.target.result;
  };
  DBOpenRequest.onerror = function () {
    console.log("æ•°æ®åº“æ‰“å¼€æŠ¥é”™");
  };
  DBOpenRequest.onupgradeneeded = function (event) {
    // æ•°æ®åº“åˆ›å»ºæˆ–å‡çº§çš„æ—¶å€™ä¼šè§¦å‘
    db = event.target.result;
    // åˆ›å»ºå¯¹è±¡åº“ï¼Œå³å­˜å‚¨è¡¨
    db.createObjectStore(storeName, {
      keyPath:'key' ,
    });
  };
};
```

#### æ·»åŠ æ•°æ®

```js
const addData = () => {
  let objectStoreRequest = db
    .transaction([storeName], "readwrite") // äº‹åŠ¡å¯¹è±¡ æŒ‡å®šè¡¨æ ¼åç§°å’Œæ“ä½œæ¨¡å¼ï¼ˆ"åªè¯»"æˆ–"è¯»å†™"ï¼‰
    .objectStore(storeName) // ä»“åº“å¯¹è±¡
    .add({
      key: "Walk dog",
      hours: 19,
      minutes: 30,
      day: 24,
      month: "December",
      year: 2014,
      notified: "no",
    });

  objectStoreRequest.onsuccess = function () {
    console.log("æ•°æ®å†™å…¥æˆåŠŸ");
  };

  objectStoreRequest.onerror = function (event) {
    console.log("æ•°æ®å†™å…¥å¤±è´¥");
    throw new Error(event.target.error);
  };
};
```

#### æŸ¥è¯¢è·å–æ•°æ®

```js
const getData = ()=> {
  let transaction = db.transaction([storeName], "readwrite"); // äº‹åŠ¡
  let objectStore = transaction.objectStore(storeName); // ä»“åº“å¯¹è±¡
  let request = objectStore.get("Walk dog");

  request.onerror = function (event) {
    console.log("äº‹åŠ¡å¤±è´¥");
  };

  request.onsuccess = function (event) {
    console.log("ä¸»é”®æŸ¥è¯¢ç»“æœ: ", request.result);
  };  
}
```

#### ä¿®æ”¹æ•°æ®

```js
const updateData = ()=> {
  let transaction = db.transaction([storeName], "readwrite"); // äº‹åŠ¡
  let objectStore = transaction.objectStore(storeName); // ä»“åº“å¯¹è±¡
  let request = objectStore.get("Walk dog2");  // è·å–keyå€¼ä¸ºWalk dog2çš„æ•°æ®

  request.onerror = function (event) {
    console.log("äº‹åŠ¡å¤±è´¥");
  };
  request.onsuccess = function (event) {
    const data = request.result || {key:'Walk dog2'};  // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º
    console.log("ä¸»é”®æŸ¥è¯¢ç»“æœ: ", data);
    data.notified = "yes";
    const updateRequest = objectStore.put(data);  // å…¥åº“ä¿®æ”¹
    updateRequest.onsuccess = () => {
      console.log("ä¿®æ”¹æˆåŠŸ ");
    };
  };
}
```

#### åˆ é™¤æ•°æ®

```js
function deleteData() {
    let request = db.transaction([storeName],'readwrite').objectStore(storeName).delete('Walk dog2')

    request.onsuccess = function () {
        console.log('æ•°æ®åˆ é™¤æˆåŠŸ')
    }

    request.onerror = function () {
        console.log('æ•°æ®åˆ é™¤å¤±è´¥')
    }
}
```

æ›´å¤šAPIå¯å‚è€ƒ[æ–‡æ¡£ç›´é€šè½¦](https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FIndexedDB_API%23%E7%A4%BA%E4%BE%8B)

çœ‹åˆ°è¿™ï¼Œæ˜¯ä¸æ˜¯æœ‰é‚£ä¹ˆäº›æ”¾å¼ƒçš„æƒ³æ³•äº†ğŸ¤£ğŸ¤£ã€‚å…„å˜šï¼Œè«è¦æ‰æ€¥ï¼Œä»¥ä¸‹é€šè¿‡localforageå®ç°æ›´ç®€å•çš„æ“ä½œğŸ¤”ğŸ¤”ğŸ¤”

## localforage

[localForage](https://link.juejin.cn/?target=https%3A%2F%2Flocalforage.docschina.org%2F%23) æ˜¯ä¸€ä¸ª JavaScript åº“ï¼Œé€šè¿‡ç®€å•ç±»ä¼¼ `localStorage` API çš„å¼‚æ­¥å­˜å‚¨æ¥æ”¹è¿›ä½ çš„ Web åº”ç”¨ç¨‹åºçš„ç¦»çº¿ä½“éªŒã€‚å®ƒèƒ½å­˜å‚¨å¤šç§ç±»å‹çš„æ•°æ®ï¼Œè€Œä¸ä»…ä»…æ˜¯å­—ç¬¦ä¸²ã€‚

localForage æœ‰ä¸€ä¸ªä¼˜é›…é™çº§ç­–ç•¥ï¼Œè‹¥æµè§ˆå™¨ä¸æ”¯æŒ IndexedDB æˆ– WebSQLï¼Œåˆ™ä½¿ç”¨ localStorageã€‚åœ¨æ‰€æœ‰ä¸»æµæµè§ˆå™¨ä¸­éƒ½å¯ç”¨ï¼šChromeï¼ŒFirefoxï¼ŒIE å’Œ Safariï¼ˆåŒ…æ‹¬ Safari Mobileï¼‰

#### å®‰è£…

```js
npm install localforage
```

### æ”¹è¿›çš„ç¦»çº¿å­˜å‚¨

```js
// é€šè¿‡ localStorage è®¾ç½®å€¼
localStorage.setItem('key', JSON.stringify('value')); 
doSomethingElse(); 

// é€šè¿‡ localForage å®ŒæˆåŒæ ·åŠŸèƒ½ 
localforage.setItem('key', 'value').then(doSomethingElse); 
// localForage åŒæ ·æ”¯æŒå›è°ƒå‡½æ•° 
localforage.setItem('key', 'value', doSomethingElse);

//å–å€¼
localforage.getItem('key').then((value)=>{
console.log(value)
})

// åˆ é™¤
localforage.removeItem('key').then(function() { // å½“å€¼è¢«ç§»é™¤åï¼Œæ­¤å¤„ä»£ç è¿è¡Œ 
console.log('Key is cleared!');
})

//ä»æ•°æ®åº“ä¸­åˆ é™¤æ‰€æœ‰çš„ keyï¼Œé‡ç½®æ•°æ®åº“
localforage.clear().then(function() { // å½“æ•°æ®åº“è¢«å…¨éƒ¨åˆ é™¤åï¼Œæ­¤å¤„ä»£ç è¿è¡Œ 
  console.log('Database is now empty.'); 
})
```

#### é…ç½®ï¼ˆå¯é€‰ï¼‰

è®¾ç½® localForage é€‰é¡¹ï¼Œ[è¯¦è§æ–‡æ¡£](https://link.juejin.cn/?target=https%3A%2F%2Flocalforage.docschina.org%2F%23api-config)

```js
localforage.config({
  //æŒ‰é¡ºåºä½¿ç”¨çš„é¦–é€‰é©±åŠ¨,é»˜è®¤å€¼ï¼š[localforage.INDEXEDDB, localforage.WEBSQL, localforage.LOCALSTORAGE]
  driver: [localforage.INDEXEDDB, localforage.WEBSQL, localforage.LOCALSTORAGE],
  // æ•°æ®åº“çš„åç§°ï¼Œé»˜è®¤å€¼ï¼š'localforage'
  name: "localforageTest", 
  //æ•°æ®ä»“åº“çš„åç§°,é»˜è®¤å€¼ï¼š'keyvaluepairs'
  storeName: "localforageStore", 
  //æ•°æ®åº“çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚ç°åœ¨åªç”¨äºWebSQLã€‚ é»˜è®¤å€¼ï¼š4980736
  size: 1024 * 500, 
  //æ•°æ®åº“çš„ç‰ˆæœ¬ã€‚å°†æ¥å¯ç”¨äºå‡çº§; ç›®å‰æœªä½¿ç”¨ã€‚é»˜è®¤å€¼ï¼š1.0
  version: 1.0, 
  //æ•°æ®åº“çš„æè¿°ï¼Œä¸€èˆ¬æ˜¯æä¾›ç»™å¼€å‘è€…çš„ã€‚é»˜è®¤å€¼ï¼š''
  description: "", 
});
```

é…ç½®å®Œåæ·»åŠ æ•°æ®ï¼Œå¦‚ä¸‹

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f3c8b49c09964b6181409563068c4c04~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=958&h=602&s=84516&e=png&b=ffffff)

### åˆ›å»ºå¤šä¸ªå®ä¾‹

å½“ç›´æ¥ä½¿ç”¨localforageæ—¶ï¼Œä¼šé»˜è®¤åˆ›å»ºå¹¶ä½¿ç”¨å®ä¾‹ã€‚

`createInstance`:åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ª localForage çš„æ–°å®ä¾‹ã€‚æ¯ä¸ªå®ä¾‹å¯¹è±¡éƒ½æœ‰ç‹¬ç«‹çš„æ•°æ®åº“ï¼Œè€Œä¸ä¼šå½±å“åˆ°å…¶ä»–å®ä¾‹ã€‚

```js
const store1 = localforage.createInstance({
  name: "store1",
  storeName: "localforageStore1",
});

const store2 = localforage.createInstance({
  name: "store2",
  storeName: "localforageStore2",
});
const store3 = localforage.createInstance({
  name: "store2",
  storeName: "localforageStore3",
});
store1.setItem('store1key',{myKey:'myValue'})
store2.setItem('store2key',{myKey:'myValue'})
store3.setItem('store3key',{myKey:'myValue'})
```

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6aae34cf11404763bc3ffe3d7d5c25c4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1266&h=816&s=134489&e=png&b=fefefe)

### å®ä¾‹åˆ é™¤

`dropInstance`:

1. è°ƒç”¨æ—¶ï¼Œè‹¥ä¸ä¼ å‚ï¼Œå°†åˆ é™¤å½“å‰å®ä¾‹çš„ â€œæ•°æ®ä»“åº“â€ ã€‚
2. è°ƒç”¨æ—¶ï¼Œè‹¥å‚æ•°ä¸ºä¸€ä¸ªæŒ‡å®šäº† `name` å’Œ `storeName` å±æ€§çš„å¯¹è±¡ï¼Œä¼šåˆ é™¤æŒ‡å®šçš„ â€œæ•°æ®ä»“åº“â€ã€‚
3. è°ƒç”¨æ—¶ï¼Œè‹¥å‚æ•°ä¸ºä¸€ä¸ªä»…æŒ‡å®šäº† `name` å±æ€§çš„å¯¹è±¡ï¼Œå°†åˆ é™¤æŒ‡å®šçš„ â€œæ•°æ®åº“â€ï¼ˆåŠå…¶æ‰€æœ‰æ•°æ®ä»“åº“ï¼‰ã€‚

```js
jsä»£ç è§£è¯»å¤åˆ¶ä»£ç   localforage.dropInstance()
  localforage.dropInstance({
    name: "store1",
  })
  localforage.dropInstance({
    name: "store2",
    storeName:'localforageStore3'
  })
```

åˆ°è¿™ï¼Œç›¸ä¿¡ä½ å·²ç»å­¦ä¼šäº†localforageäº†ğŸ‘ğŸ‘ğŸ‘ğŸ‘

å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ç»“åˆå…¶ä»–çŠ¶æ€ç®¡ç†å·¥å…·(Pinia,vuex,mobxç­‰)å®ç°æ›´é«˜çº§çš„å°è£…ä¸ä½¿ç”¨ğŸ˜ğŸ˜ğŸ˜